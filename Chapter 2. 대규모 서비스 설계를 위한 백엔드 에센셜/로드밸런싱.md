# ë¡œë“œë°¸ëŸ°ì‹±

### LoadBalancerë€

: ì‚¬ìš©ìì˜ ìš”ì²­ì„ ì—¬ëŸ¬ ì„œë²„ë¡œ ë¶„ë°°í•´ì£¼ëŠ” í•˜ë“œì›¨ì–´ or ì†Œí”„íŠ¸ì›¨ì–´ ì¥ë¹„

  ìš”ì²­ìëŠ” LoadBalancer ë’¤ì˜ ëª©ë¡ì€ ì•Œì§€ ëª»í•œë‹¤.

![Untitled](image/Untitled.png)

<br><br>

### ì†Œí”„íŠ¸ì›¨ì–´ LoadBalancer

:nginx, HaProxyë“±ì˜ ìœ ëª…í•œ ì†Œí”„íŠ¸ì›¨ì–´ LoadBanlencerê°€ ì¡´ì¬í•œë‹¤.

![Untitled](image/Untitled%201.png)

:ì„œë¹„ìŠ¤ê°€ ì´ì–´ì§€ëŠ”ê²Œ ëª©ì 

lbëŠ” api serverì— ì§€ì†ì ì¸ health_checkë¥¼ í•¨

<br><br>

### server side vs client side

server side : í•˜ë“œì›¨ì–´ ì‚¬ìš© 

caller â†’ callee : callerëŠ” calleeì˜ ê°¯ìˆ˜ë¥¼ ì•Œ ìˆ˜ ì—†ë‹¤. 

![Untitled](image/Untitled%202.png)

ì¥ì 

- í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œë“œë°¸ëŸ°ì„œì˜ ì •ë³´ë§Œ ì•Œë©´ ëœë‹¤
- ì•ì—ì„œ ë°°ìš´ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ì„œ ë¦¬í€˜ìŠ¤íŠ¸ë¥¼ ë¶„ì‚°í•œë‹¤.
- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ê°œë³„ ì£¼ì†Œë¥¼ ì•Œ í•„ìš”ê°€ ì—†ë‹¤.
    - ë‹¤ë§Œ ë¡œë“œë°¸ëŸ°ì„œì˜ ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•œë‹¤.
- ì‹¤ì œì ìœ¼ë¡œ í•œ ë‹¨ê³„ë¥¼ ë” ê±°ì¹˜ë¯€ë¡œ Latencyê°€(ì§€ì—° ëŒ€ê¸° ì‹œê°„) ëŠ˜ì–´ë‚  ìˆ˜ ìˆë‹¤. (ë‹¤ì‹œ ê°”ë‹¤ê°€ ì‘ë‹µí–‡ë‹¤ê°€ ëŒì•„ì˜¨ë‹¤.) í•˜ë“œì›¨ì–´ëŠ” ë¹ ë¥¸ë° ì†Œí”„íŠ¸ì›¨ì–´ëŠ” ì ë‹¤..
    - ì´ë¥¼ Hop(í™‰)ì´ë¼ê³  ë¶€ë¥¸ë‹¤.
    
    <aside>
    ğŸ’¡ ë‹¤ìŒ ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ë¡œ íŒ¨í‚·ì´ ì´ë™í•  ë•Œë§ˆë‹¤ ë°œìƒí•˜ëŠ” ì¹´ìš´íŠ¸
    </aside>
    
- ë¡œë“œë°¸ëŸ°ì„œì— ì¥ì• ê°€ ë°œìƒí•˜ë©´ ì„œë¹„ìŠ¤ê°€ ë” ì´ìƒ ë˜ì§€ ì•ŠëŠ”ë‹¤.

![Untitled](image/Untitled%203.png)

ë‹¨ì  : ì½œëŸ¬ê°€ ì½œë¦¬ì˜ ì£¼ì†Œë¥¼ ì „ë¶€ ì•Œì•„ì•¼ í•œë‹¤.

- í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì˜ ëŒ€ìˆ˜ ë° ì£¼ì†Œë¥¼ ëª¨ë‘ ì•Œì•„ì•¼ í•œë‹¤. : ì–´ë–»ê²Œ?ê°€ ë¬¸ì œ
- Hopì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¢€ ë” ë¹ ë¥¸ latencyë¥¼ ë³´ì—¬ì¤€ë‹¤.
- ì¥ì• í¬ì¸íŠ¸ê°€ ì¤„ì–´ë“ ë‹¤. : ê°€ìš´ë°ì˜ lbê°€ ì¥ì• ê°€ ë‚ ë¦¬ê°€ ì—†ìœ¼ë‹ˆê¹Œ
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ì˜ ëª©ë¡œê³¼ ì£¼ì†Œë¥¼ ê´€ë¦¬í•´ì•¼ í•œë‹¤ëŠ” ë‹¨ì ì´ ì¡´ì¬í•œë‹¤.
    - ë§Œì•½ ì„œë²„ë“¤ì˜ ì£¼ì†Œê°€ ë°”ë€Œê±°ë‚˜, ì„œë²„ë“¤ì˜ ëª©ë¡ì´ ì¶”ê°€ë˜ê±°ë‚˜ ì‚­ì œëœë‹¤ë©´?

**: ì˜¨í”„ë¼ë¯¸ìŠ¤ëŠ” í•˜ë“œì›¨ì–´ ë¡œë“œë°¸ëŸ°ì„œê°€ ë°”ê¹¥ì— ìˆê³  ê·¸ ì•ˆì— nginxë¥¼ ë¶™í˜€ì„œ ì„œë²„ì‚¬ì´ë“œ ë¡œë“œë°¸ëŸ°ì„œë„ í•˜ëŠ”ê²Œ ì¼ë°˜ì  â†’ urlì— ëŒ€í•œ ë¼ìš°íŒ…ë„ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì—**

<br><br>

### ì‹¤ìŠµ

(ì €ë²ˆ ì‹œê°„ì— ì´ë¯¸ í•´ë‘” ë¶€ë¶„)

1. pyenv local the-red-dev
2. pyenv rehash
3. pip install -r requirments.txt

(ìƒˆë¡­ê²Œ ì‹œì‘) the red í´ë”.

1. ./install_program.sh : ì£¼í‚¤í¼ë‘ ë ˆë””ìŠ¤ ì„¤ì¹˜ : java 8, java11ì´ ê¹”ë ¤ìˆì–´ì•¼í•¨, ì£¼í‚¤í¼ë¥¼ ë¡œì»¬ì—ì„œ ëŒë¦¬ëŠ” ê²ƒ : ì£¼í‚¤í¼ë¥¼ dockerë¡œ ì˜¬ë ¤ë„ë¨ : productionì—ì„œëŠ” 3ëŒ€ë‚˜ 5ëŒ€ ì´ìš©í•´ì•¼í•¨
2. cd chapter_2/loadbalancer
3. docker build . -t charsyam/lb_scrap (ì´ë¦„ì€ ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ í•˜ëŠ” ê²ƒ)
4. docker run -e ENDPOINTS=0.0.0.0:7001 -p 7001:7001 charsyam/lb_scrap

docker run -e : í™˜ê²½ë³€ìˆ˜ ì„¤ì •. 7001ê³¼ 7001ì„ ì—°ê²°ì‹œì¼œë¼, ì´ë¯¸ì§€ ì´ë¦„ì€ 

![Untitled](image/Untitled%204.png)

![Untitled](image/Untitled%205.png)

<ë„ì»¤ ì§€ìš°ëŠ” ëª…ë ¹ì–´>

1. docker stop {lb_scrap contailner id}

2. doerm rm {lb_scrap contailner id}

3. docker run -e ENDPOINTS=0.0.0.0:7002 -p 7002:7002 charsyam/lb_scrap

![Untitled](image/Untitled%206.png)

<br>

### ì†Œí”„íŠ¸ì›¨ì–´ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ì´ìš©í•´ì„œ ì„œë²„ì‚¬ì´ë“œ ë¡œë“œë°¸ëŸ°ì‹±ì„ í•˜ëŠ” ì˜ˆì œ

: ì„œë²„ ì‚¬ì´ë“œ ë¡œë“œë°¸ëŸ°ìŠ¤ê°€ health_checkí•˜ë‹¤ê°€ ë¬¸ì œê°€ ìˆìœ¼ë©´ ë¹¼ë²„ë¦¼.

ì†Œí”„íŠ¸ì›¨ì–´ ë¡œë“œë°¸ëŸ°ì„œëŠ” nginxë‚˜ haproxyê°€ ë‹¤í•¨.  L7ë ˆì´ì–´ì—ì„œ í•˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œ. (ì´ì   L4ë„ ì§€ì›í•¨. tcp/udp) 

ì°¸ê³  : [https://prohannah.tistory.com/65](https://prohannah.tistory.com/65)

1. cd the_red/chapter_2/loadbalancer/nginx_conf

(apt getìœ¼ë¡œ nginxë¥¼ ê°€ì ¸ì™”ë‹¤ëŠ” ì „ì œí•˜ì—)

2. sudo cp scrap /etc/nginx/sites-available/            :/etc/nginx/sites-availableì— ë³µì‚¬

3. cd /etc/nginx/sites-enabled/

4. sudo ln -sf /etc/nginx/sites-available/scrap scrap :sites-availableì„ ë§í¬ ê±¸ì–´ì£¼ëŠ” ê²ƒ

scrapë‚´ìš© : backendë¥¼ í˜¸ì¶œí•˜ë©´ 7001, 7002ë¡œ ë³´ë‚´ê³ , 7000ë²ˆì—ì„œ ëŒ€ê¸°í•¨

![Untitled](image/Untitled%207.png)

![Untitled](image/Untitled%208.png)

 : 7000ë²ˆìœ¼ë¡œ ì˜¤ë©´ í”„ë¡ì‹œíŒ¨ìŠ¤ë¡œ ì „ë‹¬, 

5. sudo service nginx reload

<br>

### the_red_infra ì‹¤ìŠµ

- aws ì˜ elb(ì—˜ë¼ìŠ¤í‹± ë¡œë“œë°¸ëŸ°ì„œ)

- ë¥¼ ì´ìš©, ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë  ë•Œ elbê°€ ìë™ ìƒì„±,  target ê·¸ë£¹ì´ ë¶™ê²Œ ëœë‹¤. auto ìŠ¤ì¼€ì¼ë§ì´ ë¶™ì„ ìˆ˜ë„ ìˆê³  ê·¸ê±¸ ì´ìš©í•œ loadbalncingì„ ë³´ì—¬ì¤€ë‹¤. targetê·¸ë£¹ì´ elbë‘ ì—°ë™ë¼ì„œ target ê·¸ë£¹ì´ health_check, elbë¡œ ì˜¤ëŠ”íŠ¸ë˜í”½ì„ ì •ìƒì ì¸ ì• ë“¤í•œí…Œë§Œ ë³´ë‚´ì¤Œâ†’ nginxë‘ ë™ì¼í•œ ë™ì‘. ë‹¤ë§Œ elbì—ì„œ íšŒë³µëœì• ë“¤ì„ ì²´í¬í•˜ê³ ..ì¥ì• ë¥¼ ì²´í¬í•˜ëŠ” ..ì“°ë ˆì“°ìš¸ë“œ..

1. default num 2ë¡œ ë°”ê¿ˆ 2ëŒ€ ìƒì„±
2. terraform init 
3. terraform plan -out "output" : 8ê°œì˜ ë³€ê²½ì‚¬í•­ì´ ìƒê¸´ë‹¤. Plan: 8 to add, 0 to change, 0 to destroy.
4. terraform apply "output" : awsì—ì„œ ë§Œë“¤ì–´ì ¸ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŒ í‚¤í˜ì–´ í™•ì¸, ë³´ì•ˆ ë‚´ ip í™•ì¸

geoip_lb_dnsname = "[geoip-lb-449517090.ap-northeast-2.elb.amazonaws.com](http://geoip-lb-449517090.ap-northeast-2.elb.amazonaws.com/)"

5. vi create_hosts.py : public ips ë‘ private ips ë¹„ê¿”ì¤Œ 

6. python create_hosts.py: ë‚˜ì˜¤ëŠ” ip ë¦¬ìŠ¤íŠ¸ ë³µì‚¬

```kotlin
[ngrinder]
13.125.119.242 internal_hostname=host1 internal_ip=172.31.11.154
13.124.112.232 internal_hostname=host2 internal_ip=172.31.10.183 ngrinder_master_addr=172.31.11.154:8080
[prometheus]
13.125.119.242 internal_hostname=host1 internal_ip=172.31.11.154
[grafana]
13.125.119.242 internal_hostname=host1 internal_ip=172.31.11.154
[geoip]
13.125.119.242 internal_hostname=host1 internal_ip=172.31.11.154
13.124.112.232 internal_hostname=host2 internal_ip=172.31.10.183
nodes:
- 172.31.11.154:9100
- 172.31.10.183:9100
prometheus_node:
- 172.31.11.154:9090
geoip_nodes:
- 172.31.10.183:7001
```

7. aws/hosts

8. ansible-playbook -i aws the_red_1_base.yml

9. ansible-playbook -i aws the_red_2_geoip.yml

10. 

![Untitled](image/Untitled%209.png)

![Untitled](image/Untitled%2010.png)

![Untitled](image/Untitled%2011.png)

![Untitled](image/Untitled%2012.png)

![Untitled](image/Untitled%2013.png)

11. ë¡œë“œë°¸ëŸ°ì„œ ì£¼ì†Œë¡œ í…ŒìŠ¤íŠ¸

![Untitled](image/Untitled%2014.png)

![Untitled](image/Untitled%2015.png)

(í•œëŒ€ë¥¼ ë‚´ë ¤ë³´ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œ)

12. sudo vi ~/.ssh/config

13. ps -ef|grep gunicorn :í”„ë¡œì„¸ìŠ¤ë“¤ í™•ì¸ê°€ëŠ¥

14. sudo service gunicorn_geoip_7002 stop

![Untitled](image/Untitled%2016.png)

í—¬ìŠ¤ ì²´í¬ê°€ ì•„ì§ ì•ˆëœ ìƒíƒœ : í—¬ìŠ¤ ì²´í¬ ì£¼ê¸°ê°€ 30ì´ˆë¡œ ë˜ì–´ìˆê³ , 3ë²ˆ ì‹¤íŒ¨í•´ì•¼ ë°”ë€Œê²Œë” ì„¤ì •ë˜ì–´ìˆìŒ â†’ ì ë‹¹íˆ ì˜ ì¡°ì ˆí•˜ëŠ” ê²ƒì´ ì¤‘ìš”

![Untitled](image/Untitled%2017.png)

![Untitled](image/Untitled%2018.png)

15. sudo service gunicorn_geoip_7002 start

16. ë‹¤ì‹œ healthë¡œ ëŒì•„ì˜´

![Untitled](image/Untitled%2019.png)